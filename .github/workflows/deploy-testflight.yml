name: Deploy to TestFlight

on:
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      release_notes:
        description: "What's new in this build"
        required: false
        default: "Bug fixes and performance improvements"

concurrency:
  group: testflight-${{ github.ref }}
  cancel-in-progress: true

env:
  SCHEME: anchan
  TARGET: anchan
  BUNDLE_ID: com.codenour.anchan
  XCODE_PROJECT: anchan.xcodeproj
  CONFIGURATION: Release
  EXPORT_OPTIONS_PLIST: ExportOptions-AppStore.plist

jobs:
  deploy:
    name: Build & Deploy to TestFlight
    runs-on: macos-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Select Xcode version
        run: sudo xcode-select -s /Applications/Xcode.app

      - name: Import signing certificate
        env:
          CERTIFICATE_BASE64: ${{ secrets.CERTIFICATE_BASE64 }}
          CERTIFICATE_PASSWORD: ${{ secrets.CERTIFICATE_PASSWORD }}
          KEYCHAIN_PASSWORD: ${{ secrets.KEYCHAIN_PASSWORD }}
        run: |
          CERTIFICATE_PATH=$RUNNER_TEMP/certificate.p12
          KEYCHAIN_PATH=$RUNNER_TEMP/signing.keychain-db

          echo -n "$CERTIFICATE_BASE64" | base64 --decode -o "$CERTIFICATE_PATH"

          security create-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          security set-keychain-settings -lut 21600 "$KEYCHAIN_PATH"
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"

          security import "$CERTIFICATE_PATH" \
            -P "$CERTIFICATE_PASSWORD" \
            -A -t cert -f pkcs12 \
            -k "$KEYCHAIN_PATH"

          security list-keychain -d user -s "$KEYCHAIN_PATH"

      - name: Install provisioning profile
        env:
          PROVISIONING_PROFILE_BASE64: ${{ secrets.PROVISIONING_PROFILE_BASE64 }}
        run: |
          PROFILE_PATH="$HOME/Library/MobileDevice/Provisioning Profiles"
          mkdir -p "$PROFILE_PATH"
          echo -n "$PROVISIONING_PROFILE_BASE64" | base64 --decode \
            -o "$PROFILE_PATH/anchan_appstore.mobileprovision"

      - name: Create ExportOptions plist (App Store)
        env:
          TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
          PROVISIONING_PROFILE_NAME: ${{ secrets.PROVISIONING_PROFILE_NAME }}
        run: |
          cat > $EXPORT_OPTIONS_PLIST << EOF
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
            <key>method</key>
            <string>app-store</string>
            <key>teamID</key>
            <string>${TEAM_ID}</string>
            <key>uploadBitcode</key>
            <false/>
            <key>uploadSymbols</key>
            <true/>
            <key>provisioningProfiles</key>
            <dict>
              <key>${BUNDLE_ID}</key>
              <string>${PROVISIONING_PROFILE_NAME}</string>
            </dict>
          </dict>
          </plist>
          EOF

      - name: Increment build number
        run: |
          BUILD_NUMBER=${{ github.run_number }}
          agvtool new-version -all $BUILD_NUMBER

      - name: Archive app
        run: |
          xcodebuild archive \
            -project "$XCODE_PROJECT" \
            -scheme "$SCHEME" \
            -configuration "$CONFIGURATION" \
            -archivePath "$RUNNER_TEMP/anchan.xcarchive" \
            -destination "generic/platform=iOS" \
            CODE_SIGN_STYLE=Manual \
            DEVELOPMENT_TEAM=${{ secrets.APPLE_TEAM_ID }} \
            | xcpretty || true

      - name: Export IPA
        run: |
          xcodebuild -exportArchive \
            -archivePath "$RUNNER_TEMP/anchan.xcarchive" \
            -exportOptionsPlist "$EXPORT_OPTIONS_PLIST" \
            -exportPath "$RUNNER_TEMP/export" \
            | xcpretty || true

      - name: Upload to TestFlight
        env:
          APP_STORE_CONNECT_API_KEY_ID: ${{ secrets.APP_STORE_CONNECT_API_KEY_ID }}
          APP_STORE_CONNECT_API_KEY_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_API_KEY_ISSUER_ID }}
          APP_STORE_CONNECT_API_KEY_CONTENT: ${{ secrets.APP_STORE_CONNECT_API_KEY_CONTENT }}
        run: |
          KEY_DIR=$RUNNER_TEMP/private_keys
          mkdir -p "$KEY_DIR"
          echo -n "$APP_STORE_CONNECT_API_KEY_CONTENT" \
            > "$KEY_DIR/AuthKey_${APP_STORE_CONNECT_API_KEY_ID}.p8"

          xcrun altool --upload-app \
            --type ios \
            --file "$RUNNER_TEMP/export/anchan.ipa" \
            --apiKey "$APP_STORE_CONNECT_API_KEY_ID" \
            --apiIssuer "$APP_STORE_CONNECT_API_KEY_ISSUER_ID" \
            --verbose

      - name: Clean up keychain and profiles
        if: always()
        run: |
          security delete-keychain "$RUNNER_TEMP/signing.keychain-db" || true
          rm -f "$HOME/Library/MobileDevice/Provisioning Profiles/anchan_appstore.mobileprovision"

      - name: Upload archive as artifact (on failure)
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: failed-archive
          path: ${{ runner.temp }}/anchan.xcarchive
          retention-days: 3
